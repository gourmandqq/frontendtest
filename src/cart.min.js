class Cart{constructor(){this.items=new Map,this.cartCounter=document.querySelector(".block_cartcart a"),this.init()}init(){this.loadFromStorage(),this.updateCartCounter(),this.setupEventListeners()}setupEventListeners(){document.addEventListener("click",t=>{if(t.target.classList.contains("cart_button")||t.target.closest(".cart_button")){const e=t.target.classList.contains("cart_button")?t.target:t.target.closest(".cart_button");this.addToCart(e)}})}addToCart(t){const e=t.closest(".product"),r=this.getProductId(e),o=this.getProductInfo(e);if(!r)return void console.error("Не удалось определить ID товара");const s=this.items.get(r);s?(s.quantity+=1,this.items.set(r,s)):this.items.set(r,{...o,quantity:1,id:r}),this.saveToStorage(),this.updateCartCounter(),this.showAddToCartAnimation(t)}getProductId(t){const e=t.querySelector("h3")?.textContent||"",r=t.querySelector("h4")?.textContent||"";return btoa(encodeURIComponent(`${e}-${r}`)).substring(0,16)}getProductInfo(t){return{name:t.querySelector("h3")?.textContent||"Неизвестный товар",price:t.querySelector("h4")?.textContent||"0 руб.",image:t.querySelector("img")?.src||"",originalPrice:t.querySelector("h5 s")?.textContent||null}}updateCartCounter(){if(!this.cartCounter)return;const t=this.getTotalItems();this.cartCounter.textContent.split(" (")[0];this.cartCounter.innerHTML=t>0?`Корзина <span class="cart-counter">(${t})</span>`:"Корзина"}getTotalItems(){let t=0;for(const e of this.items.values())t+=e.quantity;return t}showAddToCartAnimation(t){const e=t.textContent;t.textContent="Добавлено!",t.style.backgroundColor="#4CAF50",t.style.color="white",t.style.borderColor="#4CAF50",setTimeout(()=>{t.textContent=e,t.style.backgroundColor="",t.style.color="",t.style.borderColor=""},1e3)}saveToStorage(){try{const t=JSON.stringify(Array.from(this.items.entries()));localStorage.setItem("moda-optic-cart",t)}catch(t){console.error("Ошибка сохранения корзины:",t)}}loadFromStorage(){try{const t=localStorage.getItem("moda-optic-cart");if(t){const e=JSON.parse(t);this.items=new Map(e)}}catch(t){console.error("Ошибка загрузки корзины:",t),this.items=new Map}}removeItem(t){this.items.delete(t),this.saveToStorage(),this.updateCartCounter()}updateQuantity(t,e){if(e<=0)this.removeItem(t);else{const r=this.items.get(t);r&&(r.quantity=e,this.items.set(t,r),this.saveToStorage(),this.updateCartCounter())}}clearCart(){this.items.clear(),this.saveToStorage(),this.updateCartCounter()}getItems(){return Array.from(this.items.values())}}export default Cart;